<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ë–µ–ª—ã–π –ü–∞—É—á–æ–∫</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #050508;
    --surface: #0d0d14;
    --surface2: #13131e;
    --border: rgba(255,255,255,0.06);
    --accent: #7fff6e;
    --accent2: #00d4ff;
    --warm: #ff9f43;
    --hot: #ff4757;
    --text: #e8e8f0;
    --muted: rgba(232,232,240,0.4);
    --mono: 'Space Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    overflow: hidden;
  }

  .web-bg {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }
  .web-bg svg {
    width: 100%;
    height: 100%;
    opacity: 0.07;
  }

  .noise {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    opacity: 0.03;
  }

  .app {
    position: relative;
    z-index: 2;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .header {
    padding: 20px 20px 0;
    flex-shrink: 0;
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-icon {
    width: 36px;
    height: 36px;
    position: relative;
  }
  .logo-icon svg {
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 0 8px var(--accent));
  }
  .logo-text {
    font-family: var(--mono);
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.1em;
    color: var(--accent);
    text-transform: uppercase;
  }
  .logo-sub {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.05em;
    margin-top: 1px;
  }
  .status-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(127,255,110,0.08);
    border: 1px solid rgba(127,255,110,0.2);
    border-radius: 20px;
    padding: 5px 12px;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--accent);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .status-dot {
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 6px var(--accent);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 6px var(--accent); }
    50% { opacity: 0.5; box-shadow: 0 0 12px var(--accent); }
  }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 12px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--accent);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.6s ease;
  }
  .stat-card.loaded::before { transform: scaleX(1); }
  .stat-card:nth-child(2)::before { background: var(--accent2); }
  .stat-card:nth-child(3)::before { background: var(--warm); }

  .stat-val {
    font-family: var(--mono);
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
    margin-bottom: 4px;
  }
  .stat-label {
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .nav {
    display: flex;
    gap: 4px;
    margin-bottom: 16px;
  }
  .nav-btn {
    flex: 1;
    background: none;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 6px;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
  }
  .nav-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
    font-weight: 700;
  }

  .content {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 100px;
    -webkit-overflow-scrolling: touch;
  }
  .content::-webkit-scrollbar { display: none; }

  .section { display: none; }
  .section.active { display: block; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .leads-list { display: flex; flex-direction: column; gap: 12px; }

  .lead-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
    animation: slideIn 0.4s ease both;
  }
  .lead-card:active { transform: scale(0.98); }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-12px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .lead-card::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, transparent 60%, rgba(127,255,110,0.03));
    pointer-events: none;
  }

  .lead-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .lead-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 3px 8px;
    border-radius: 6px;
  }
  .lead-badge.hot {
    background: rgba(255,71,87,0.15);
    color: var(--hot);
    border: 1px solid rgba(255,71,87,0.3);
  }
  .lead-badge.warm {
    background: rgba(0,212,255,0.1);
    color: var(--accent2);
    border: 1px solid rgba(0,212,255,0.2);
  }
  .lead-time {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
  }
  .lead-user {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
  }
  .lead-chat {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .lead-chat::before {
    content: '#';
    color: var(--accent);
    font-family: var(--mono);
  }
  .lead-text {
    font-size: 12px;
    color: rgba(232,232,240,0.7);
    line-height: 1.5;
    border-left: 2px solid var(--border);
    padding-left: 10px;
    margin-bottom: 12px;
    font-style: italic;
    white-space: pre-wrap;
  }
  .lead-score-bar {
    height: 3px;
    background: rgba(255,255,255,0.06);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 12px;
  }
  .lead-score-fill {
    height: 100%;
    border-radius: 2px;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    transition: width 1s ease;
  }
  .lead-actions {
    display: flex;
    gap: 8px;
  }
  .btn-write {
    flex: 1;
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 10px;
    padding: 10px;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-write:active { transform: scale(0.97); background: #6de860; }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
  }
  .empty-spider {
    font-size: 48px;
    margin-bottom: 16px;
    animation: float 3s ease-in-out infinite;
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
  }
  .empty-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
  }
  .empty-sub {
    font-size: 13px;
    color: var(--muted);
    line-height: 1.6;
    word-break: break-word;
  }

  .profile-section { display: flex; flex-direction: column; gap: 12px; }

  .profile-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px;
  }
  .profile-card-title {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--accent);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .profile-card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }
  .profile-row {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .profile-row:last-child { border-bottom: none; }
  .profile-row-icon {
    font-size: 16px;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
    margin-top: 1px;
  }
  .profile-row-label {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 2px;
    letter-spacing: 0.04em;
  }
  .profile-row-val {
    font-size: 13px;
    color: var(--text);
    font-weight: 500;
    line-height: 1.4;
    white-space: pre-wrap;
  }

  .plan-card {
    background: linear-gradient(135deg, rgba(127,255,110,0.06), rgba(0,212,255,0.04));
    border: 1px solid rgba(127,255,110,0.2);
    border-radius: 16px;
    padding: 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .plan-name {
    font-size: 18px;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 4px;
  }
  .plan-until {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
  }
  .plan-badge {
    background: var(--accent);
    color: var(--bg);
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 700;
    padding: 6px 14px;
    border-radius: 8px;
    letter-spacing: 0.05em;
  }

  .limit-bar-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 16px;
  }
  .limit-top {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .limit-label {
    font-size: 12px;
    color: var(--muted);
  }
  .limit-val {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--accent);
  }
  .limit-bar {
    height: 6px;
    background: rgba(255,255,255,0.06);
    border-radius: 4px;
    overflow: hidden;
  }
  .limit-fill {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    transition: width 1s cubic-bezier(0.16,1,0.3,1);
  }

  .control-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .ctrl-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  .ctrl-btn:active { transform: scale(0.97); border-color: var(--accent); }
  .ctrl-btn-icon { font-size: 22px; }
  .ctrl-btn-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text);
  }
  .ctrl-btn-sub {
    font-size: 10px;
    color: var(--muted);
    font-family: var(--mono);
  }

  .analytics-section { display: flex; flex-direction: column; gap: 12px; }

  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px;
  }
  .chart-title {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--accent);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 16px;
  }
  .bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 6px;
    height: 80px;
  }
  .bar-col {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    height: 100%;
    justify-content: flex-end;
  }
  .bar {
    width: 100%;
    border-radius: 4px 4px 0 0;
    background: linear-gradient(180deg, var(--accent2), rgba(0,212,255,0.3));
    transition: height 1s cubic-bezier(0.16,1,0.3,1);
    min-height: 4px;
  }
  .bar.today { background: linear-gradient(180deg, var(--accent), rgba(127,255,110,0.3)); }
  .bar-day {
    font-family: var(--mono);
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.04em;
  }

  .funnel-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 18px;
  }
  .funnel-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
  }
  .funnel-label {
    font-size: 12px;
    color: var(--muted);
    width: 80px;
    flex-shrink: 0;
  }
  .funnel-bar-wrap {
    flex: 1;
    height: 24px;
    background: rgba(255,255,255,0.04);
    border-radius: 6px;
    overflow: hidden;
  }
  .funnel-fill {
    height: 100%;
    border-radius: 6px;
    display: flex;
    align-items: center;
    padding-left: 8px;
    font-family: var(--mono);
    font-size: 10px;
    font-weight: 700;
    color: var(--bg);
    transition: width 1s cubic-bezier(0.16,1,0.3,1);
  }

  .bottom-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 10;
    background: rgba(5,5,8,0.92);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    padding: 10px 20px calc(10px + env(safe-area-inset-bottom));
    gap: 4px;
  }
  .bnav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px 4px;
    border-radius: 12px;
    transition: all 0.2s;
    position: relative;
  }
  .bnav-btn.active { background: rgba(127,255,110,0.08); }
  .bnav-icon { font-size: 20px; line-height: 1; }
  .bnav-label {
    font-family: var(--mono);
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .bnav-btn.active .bnav-label { color: var(--accent); }

  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-80px);
    background: var(--surface2);
    border: 1px solid var(--accent);
    border-radius: 12px;
    padding: 10px 20px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--accent);
    z-index: 100;
    transition: transform 0.3s cubic-bezier(0.16,1,0.3,1);
    white-space: nowrap;
    box-shadow: 0 4px 30px rgba(127,255,110,0.15);
    max-width: calc(100vw - 40px);
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .spider-loader {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
  }
  .spider-spin {
    font-size: 32px;
    animation: spin 2s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .badge {
    position: absolute;
    top: -2px; right: -2px;
    background: var(--hot);
    color: white;
    font-family: var(--mono);
    font-size: 9px;
    font-weight: 700;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .calibration-banner {
    background: linear-gradient(135deg, rgba(255,159,67,0.1), rgba(255,71,87,0.05));
    border: 1px solid rgba(255,159,67,0.3);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    display: none;
  }
  .calibration-banner.show { display: block; animation: fadeIn 0.4s ease; }
  .cal-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--warm);
    margin-bottom: 6px;
  }
  .cal-sub {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 12px;
    line-height: 1.5;
  }
  .cal-btns { display: flex; gap: 8px; }
  .cal-btn {
    flex: 1;
    padding: 9px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--surface2);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .cal-btn.good { color: var(--accent); border-color: rgba(127,255,110,0.3); }
  .cal-btn.bad { color: var(--hot); border-color: rgba(255,71,87,0.3); }
  .cal-btn:active { transform: scale(0.97); }
</style>
</head>
<body>

<div class="web-bg">
  <svg viewBox="0 0 400 800" preserveAspectRatio="xMidYMid slice">
    <defs>
      <radialGradient id="rg" cx="50%" cy="20%">
        <stop offset="0%" stop-color="#7fff6e" stop-opacity="0.15"/>
        <stop offset="100%" stop-color="#7fff6e" stop-opacity="0"/>
      </radialGradient>
    </defs>
    <g stroke="white" stroke-width="0.5" opacity="0.6">
      <line x1="200" y1="150" x2="200" y2="0"/>
      <line x1="200" y1="150" x2="350" y2="50"/>
      <line x1="200" y1="150" x2="400" y2="200"/>
      <line x1="200" y1="150" x2="320" y2="350"/>
      <line x1="200" y1="150" x2="200" y2="380"/>
      <line x1="200" y1="150" x2="80" y2="350"/>
      <line x1="200" y1="150" x2="0" y2="200"/>
      <line x1="200" y1="150" x2="50" y2="50"/>
    </g>
    <g stroke="white" stroke-width="0.4" fill="none" opacity="0.4">
      <path d="M200,40 Q310,90 350,150 Q310,210 200,250 Q90,210 50,150 Q90,90 200,40"/>
      <path d="M200,10 Q360,80 390,190 Q340,280 200,320 Q60,280 10,190 Q40,80 200,10"/>
    </g>
    <circle cx="200" cy="150" r="300" fill="url(#rg)" opacity="0.5"/>
  </svg>
</div>
<div class="noise"></div>

<div class="toast" id="toast"></div>

<div class="app">
  <div class="header">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="0 0 36 36" fill="none">
            <circle cx="18" cy="16" r="7" fill="#7fff6e" opacity="0.9"/>
            <circle cx="18" cy="16" r="4" fill="#050508"/>
            <circle cx="18" cy="16" r="1.5" fill="#7fff6e"/>
            <line x1="11" y1="12" x2="3" y2="7" stroke="#7fff6e" stroke-width="1.2" stroke-linecap="round"/>
            <line x1="11" y1="16" x2="2" y2="16" stroke="#7fff6e" stroke-width="1.2" stroke-linecap="round"/>
            <line x1="11" y1="20" x2="3" y2="25" stroke="#7fff6e" stroke-width="1.2" stroke-linecap="round"/>
            <line x1="25" y1="12" x2="33" y2="7" stroke="#7fff6e" stroke-width="1.2" stroke-linecap="round"/>
            <line x1="25" y1="16" x2="34" y2="16" stroke="#7fff6e" stroke-width="1.2" stroke-linecap="round"/>
            <line x1="25" y1="20" x2="33" y2="25" stroke="#7fff6e" stroke-width="1.2" stroke-linecap="round"/>
            <line x1="18" y1="9" x2="18" y2="2" stroke="#7fff6e" stroke-width="0.8" opacity="0.5"/>
          </svg>
        </div>
        <div>
          <div class="logo-text">–ë–µ–ª—ã–π –ø–∞—É—á–æ–∫</div>
          <div class="logo-sub">Lead Hunter v2.0</div>
        </div>
      </div>
      <div class="status-pill" id="status-pill">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">ACTIVE</span>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card" id="sc1">
        <div class="stat-val" id="stat-today">0</div>
        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
      </div>
      <div class="stat-card" id="sc2">
        <div class="stat-val" id="stat-total">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ –ª–∏–¥–æ–≤</div>
      </div>
      <div class="stat-card" id="sc3">
        <div class="stat-val" id="stat-days">0</div>
        <div class="stat-label">–î–Ω–µ–π –∞–∫—Ç–∏–≤–µ–Ω</div>
      </div>
    </div>

    <div class="nav">
      <button class="nav-btn active" onclick="switchTab('leads',this)">–õ–∏–¥—ã</button>
      <button class="nav-btn" onclick="switchTab('profile',this)">–ü—Ä–æ—Ñ–∏–ª—å</button>
      <button class="nav-btn" onclick="switchTab('analytics',this)">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>
  </div>

  <div class="content">

    <div class="section active" id="sec-leads">
      <div class="calibration-banner" id="cal-banner">
        <div class="cal-title">üéØ –ö–∞–∫ –ª–∏–¥—ã?</div>
        <div class="cal-sub">–°–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ ‚Äî —è –ø–æ–¥—Å—Ç—Ä–æ—é –ø–æ–∏—Å–∫ —Ç–æ—á–Ω–µ–µ –ø–æ–¥ —Ç–µ–±—è</div>
        <div class="cal-btns">
          <button class="cal-btn good" onclick="calibrate('good')">üëç –û–≥–æ–Ω—å</button>
          <button class="cal-btn bad" onclick="calibrate('bad')">üëé –ù–µ —Ç–æ</button>
        </div>
      </div>

      <div class="leads-list" id="leads-list">
        <div class="spider-loader"><div class="spider-spin">üï∑</div></div>
      </div>
    </div>

    <div class="section" id="sec-profile">
      <div class="profile-section">
        <div class="plan-card">
          <div>
            <div class="plan-name" id="plan-name">‚Äî</div>
            <div class="plan-until" id="plan-until">‚Äî</div>
          </div>
          <div class="plan-badge" id="plan-badge">‚Äî</div>
        </div>

        <div class="limit-bar-wrap">
          <div class="limit-top">
            <div class="limit-label">–õ–∏–¥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div>
            <div class="limit-val" id="limit-text">0 / 0</div>
          </div>
          <div class="limit-bar">
            <div class="limit-fill" id="limit-fill" style="width:0%"></div>
          </div>
        </div>

        <div class="profile-card">
          <div class="profile-card-title">–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
          <div class="profile-row">
            <div class="profile-row-icon">üíº</div>
            <div>
              <div class="profile-row-label">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</div>
              <div class="profile-row-val" id="prof-profession">‚Äî</div>
            </div>
          </div>
          <div class="profile-row">
            <div class="profile-row-icon">üéØ</div>
            <div>
              <div class="profile-row-label">–¢–≤–æ–π –∫–ª–∏–µ–Ω—Ç</div>
              <div class="profile-row-val" id="prof-target">‚Äî</div>
            </div>
          </div>
          <div class="profile-row">
            <div class="profile-row-icon">üí∞</div>
            <div>
              <div class="profile-row-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
              <div class="profile-row-val" id="prof-check">‚Äî</div>
            </div>
          </div>
          <div class="profile-row">
            <div class="profile-row-icon">üîç</div>
            <div>
              <div class="profile-row-label">–ú–æ–Ω–∏—Ç–æ—Ä—é —á–∞—Ç–æ–≤</div>
              <div class="profile-row-val" id="prof-chats">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="control-grid">
          <button class="ctrl-btn" onclick="togglePause()" id="pause-btn">
            <div class="ctrl-btn-icon" id="pause-icon">‚è∏</div>
            <div class="ctrl-btn-label" id="pause-label">–ü–∞—É–∑–∞</div>
            <div class="ctrl-btn-sub" id="pause-sub">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫</div>
          </button>
          <button class="ctrl-btn" onclick="renewPlan()">
            <div class="ctrl-btn-icon">üöÄ</div>
            <div class="ctrl-btn-label">–ü—Ä–æ–¥–ª–∏—Ç—å</div>
            <div class="ctrl-btn-sub">Telegram Stars</div>
          </button>
          <button class="ctrl-btn" onclick="openSupport()">
            <div class="ctrl-btn-icon">üí¨</div>
            <div class="ctrl-btn-label">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</div>
            <div class="ctrl-btn-sub">–ù–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º</div>
          </button>
          <button class="ctrl-btn" onclick="upgradeAccount()">
            <div class="ctrl-btn-icon">‚ö°</div>
            <div class="ctrl-btn-label">–ê–ø–≥—Ä–µ–π–¥</div>
            <div class="ctrl-btn-sub">–î–æ –ü—Ä–æ</div>
          </button>
        </div>
      </div>
    </div>

    <div class="section" id="sec-analytics">
      <div class="analytics-section">
        <div class="chart-card">
          <div class="chart-title">–õ–∏–¥—ã –∑–∞ 7 –¥–Ω–µ–π</div>
          <div class="bar-chart" id="bar-chart"></div>
        </div>

        <div class="funnel-card">
          <div class="chart-title">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
          <div class="funnel-row">
            <div class="funnel-label">–ù–∞–π–¥–µ–Ω–æ</div>
            <div class="funnel-bar-wrap">
              <div class="funnel-fill" style="width:0%; background: linear-gradient(90deg,#7fff6e,#6de860);" id="f1">0</div>
            </div>
          </div>
          <div class="funnel-row">
            <div class="funnel-label">HOT</div>
            <div class="funnel-bar-wrap">
              <div class="funnel-fill" style="width:0%; background: linear-gradient(90deg,#00d4ff,#0099cc);" id="f2">0</div>
            </div>
          </div>
          <div class="funnel-row">
            <div class="funnel-label">–û—Ç–≤–µ—Ç–∏–ª–∏</div>
            <div class="funnel-bar-wrap">
              <div class="funnel-fill" style="width:0%; background: linear-gradient(90deg,#ff9f43,#e67e22);" id="f3">0</div>
            </div>
          </div>
          <div class="funnel-row">
            <div class="funnel-label">–°–æ–∑–≤–æ–Ω</div>
            <div class="funnel-bar-wrap">
              <div class="funnel-fill" style="width:0%; background: linear-gradient(90deg,#ff4757,#c0392b);" id="f4">0</div>
            </div>
          </div>
        </div>

        <div class="profile-card">
          <div class="profile-card-title">–¢–æ–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∏</div>
          <div id="top-chats"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="bottom-nav">
  <button class="bnav-btn active" onclick="switchSection('leads', this)">
    <span class="badge" id="new-badge" style="display:none">0</span>
    <div class="bnav-icon">üï∏</div>
    <div class="bnav-label">–õ–∏–¥—ã</div>
  </button>
  <button class="bnav-btn" onclick="switchSection('profile', this)">
    <div class="bnav-icon">üë§</div>
    <div class="bnav-label">–ü—Ä–æ—Ñ–∏–ª—å</div>
  </button>
  <button class="bnav-btn" onclick="switchSection('analytics', this)">
    <div class="bnav-icon">üìä</div>
    <div class="bnav-label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
  </button>
</div>

<script>
/**
 * ‚úÖ –í–ê–ñ–ù–û:
 * –ü–æ—Å—Ç–∞–≤—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π trycloudflare URL, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≤–æ–¥–∏—Ç cloudflared.
 * –ü—Ä–∏–º–µ—Ä –∏–∑ —Ç–≤–æ–µ–≥–æ –ª–æ–≥–∞:
 *   https://shoot-properly-galleries-nova.trycloudflare.com
 */
const API_BASE = "https://manually-fundamentals-worm-insert.trycloudflare.com"; // <-- –ó–ê–ú–ï–ù–ò –ù–ê –ê–ö–¢–£–ê–õ–¨–ù–´–ô

const tg = window.Telegram?.WebApp;

if (tg) {
  tg.ready();
  tg.expand();
  tg.setHeaderColor('#050508');
  tg.setBackgroundColor('#050508');
}

// --- helpers ---
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

function animateNumber(id, target) {
  const el = document.getElementById(id);
  target = Number(target || 0);
  let start = 0;
  const step = Math.max(1, Math.ceil(target / 30));
  const interval = setInterval(() => {
    start = Math.min(start + step, target);
    el.textContent = start;
    if (start >= target) clearInterval(interval);
  }, 40);
}

function safeText(x) {
  if (x === null || x === undefined) return "‚Äî";
  const s = String(x);
  return s.length ? s : "‚Äî";
}

// --- API ---
function getInitData() {
  const initData = tg?.initData || "";
  if (!initData) throw new Error("–ù–µ—Ç initData. –û—Ç–∫—Ä–æ–π Mini App –≤–Ω—É—Ç—Ä–∏ Telegram.");
  return initData;
}

async function apiPost(path, payload = {}) {
  const initData = getInitData();

  // –î–µ–ª–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: –∏ header, –∏ body.
  const r = await fetch(`${API_BASE}${path}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-TG-INITDATA": initData,
    },
    body: JSON.stringify({ initData, ...payload }),
  });

  if (!r.ok) {
    const txt = await r.text();
    throw new Error(txt || `HTTP ${r.status}`);
  }
  return r.json();
}

// --- UI renderers ---
function renderLeadsFromAPI(items) {
  const list = document.getElementById('leads-list');
  items = Array.isArray(items) ? items : [];

  if (!items.length) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-spider">üï∑</div>
        <div class="empty-title">–ü–∞—É—á–æ–∫ –∏—â–µ—Ç...</div>
        <div class="empty-sub">–õ–∏–¥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
      </div>`;
    return;
  }

  list.innerHTML = items.map((lead, i) => {
    const score = Number(lead.score || 0);
    const badgeClass = score >= 0.8 ? 'hot' : 'warm';
    const badgeText = score >= 0.8 ? 'üî• –ì–æ—Ä—è—á–∏–π' : '‚ö° –¢—ë–ø–ª—ã–π';
    const time = (lead.sent_at || "").slice(11,16);

    const username = lead.lead_username ? '@' + lead.lead_username : "–±–µ–∑–Ω–∏–∫–∞";
    const chatTitle = safeText(lead.chat_title);
    const text = safeText(lead.message_text);

    return `
      <div class="lead-card" style="animation-delay:${i * 0.08}s">
        <div class="lead-card-header">
          <div class="lead-badge ${badgeClass}">${badgeText}</div>
          <div class="lead-time">${time || ''}</div>
        </div>
        <div class="lead-user">${username}</div>
        <div class="lead-chat">${chatTitle}</div>
        <div class="lead-text">${text}</div>
        <div class="lead-score-bar">
          <div class="lead-score-fill" style="width:${Math.max(0, Math.min(100, score * 100))}%"></div>
        </div>
        <div class="lead-actions">
          <button class="btn-write" onclick="openLead(${Number(lead.lead_user_id || 0)})">‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
      </div>
    `;
  }).join('');
}

function renderChartFromAPI(weekCounts) {
  const chart = document.getElementById('bar-chart');
  const days = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];

  let arr = Array.isArray(weekCounts) ? weekCounts.slice(0, 7) : null;
  if (!arr || !arr.length) {
    chart.innerHTML = `
      <div class="empty-state" style="padding:20px 0">
        <div class="empty-sub">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</div>
      </div>`;
    return;
  }

  // –µ—Å–ª–∏ –º–µ–Ω—å—à–µ 7 ‚Äî –¥–æ–ø–æ–ª–Ω–∏–º –Ω—É–ª—è–º–∏ —Å–ª–µ–≤–∞
  while (arr.length < 7) arr.unshift(0);

  const max = Math.max(...arr, 1);
  const todayIdx = (new Date().getDay() + 6) % 7; // Monday=0

  chart.innerHTML = arr.map((val, i) => {
    const isToday = i === todayIdx;
    const heightPct = (val / max * 85);
    return `
      <div class="bar-col">
        <div class="bar${isToday ? ' today' : ''}" style="height:0%" data-h="${heightPct}%"></div>
        <div class="bar-day">${days[i]}</div>
      </div>
    `;
  }).join('');

  setTimeout(() => {
    document.querySelectorAll('.bar').forEach(bar => {
      bar.style.height = bar.dataset.h;
    });
  }, 200);
}

function renderTopChats(topChats) {
  const el = document.getElementById('top-chats');
  topChats = Array.isArray(topChats) ? topChats : [];
  if (!topChats.length) {
    el.innerHTML = `<div class="empty-sub">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>`;
    return;
  }
  el.innerHTML = topChats.slice(0, 4).map((c, i) => `
    <div class="profile-row">
      <div class="profile-row-icon">${['ü•á','ü•à','ü•â','4Ô∏è‚É£'][i] || '‚Ä¢'}</div>
      <div style="flex:1">
        <div class="profile-row-label">${safeText(c.name || c.chat_title)}</div>
        <div class="profile-row-val">${Number(c.count || 0)} –ª–∏–¥–æ–≤</div>
      </div>
    </div>
  `).join('');
}

function setStatus(paused) {
  const dot = document.getElementById('status-dot');
  const pill = document.getElementById('status-pill');
  const txt = document.getElementById('status-text');

  if (paused) {
    txt.textContent = 'PAUSE';
    dot.style.background = '#ff4757';
    dot.style.boxShadow = '0 0 6px #ff4757';
    pill.style.background = 'rgba(255,71,87,0.08)';
    pill.style.borderColor = 'rgba(255,71,87,0.2)';
    pill.style.color = '#ff4757';
  } else {
    txt.textContent = 'ACTIVE';
    dot.style.background = 'var(--accent)';
    dot.style.boxShadow = '0 0 6px var(--accent)';
    pill.style.background = 'rgba(127,255,110,0.08)';
    pill.style.borderColor = 'rgba(127,255,110,0.2)';
    pill.style.color = 'var(--accent)';
  }
}

// --- data load ---
async function loadRealData() {
  try {
    // 1) /api/me
    const me = await apiPost("/api/me");

    // 2) /api/leads
    const leadsResp = await apiPost("/api/leads", { limit: 20 });

    // stubs safety
    const leads_today = Number(me.leads_today || 0);
    const leads_total = Number(me.leads_total || 0);

    animateNumber('stat-today', leads_today);
    animateNumber('stat-total', leads_total);

    const createdAt = me.created_at ? new Date(me.created_at) : null;
    const daysActive = createdAt ? Math.max(0, Math.floor((Date.now() - createdAt.getTime()) / 86400000)) : 0;
    animateNumber('stat-days', daysActive);

    setTimeout(() => {
      document.querySelectorAll('.stat-card').forEach(c => c.classList.add('loaded'));
    }, 250);

    const plan = (me.plan === "pro" ? "pro" : "start");
    document.getElementById('plan-name').textContent = (plan === "pro" ? "–ü—Ä–æ üöÄ" : "–°—Ç–∞—Ä—Ç ‚ö°");
    document.getElementById('plan-badge').textContent = (plan === "pro" ? "PRO" : "–°–¢–ê–†–¢");
    document.getElementById('plan-until').textContent = me.sub_until ? ("–¥–æ " + String(me.sub_until).slice(0, 10)) : "‚Äî";

    const profile = me.profile || {};
    document.getElementById('prof-profession').textContent = safeText(profile.profession);
    document.getElementById('prof-target').textContent = safeText(profile.target);
    document.getElementById('prof-check').textContent = safeText(profile.avg_check);
    document.getElementById('prof-chats').textContent = safeText(me.chats_count ? `${me.chats_count} —á–∞—Ç–æ–≤` : "‚Äî");

    const dailyLimit = (plan === "pro" ? 999 : 5);
    const pct = Math.min((leads_today / dailyLimit) * 100, 100);
    document.getElementById('limit-text').textContent = `${leads_today} / ${dailyLimit}`;
    setTimeout(() => document.getElementById('limit-fill').style.width = pct + "%", 300);

    // paused state
    const paused = me.onboarding === "paused";
    window.__isPaused = paused;
    setStatus(paused);
    syncPauseButton(paused);

    // leads list
    renderLeadsFromAPI(leadsResp.items || []);

    // badge hot leads
    const hotCount = (leadsResp.items || []).filter(x => Number(x.score || 0) >= 0.8).length;
    const badge = document.getElementById('new-badge');
    if (hotCount > 0) {
      badge.textContent = hotCount;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }

    // analytics: week chart + funnel + top chats (–µ—Å–ª–∏ –±—ç–∫ –æ—Ç–¥–∞—ë—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º, –∏–Ω–∞—á–µ –º–∏–Ω–∏–º—É–º)
    renderChartFromAPI(me.week_counts || []);
    const funnel = me.funnel || null;
    if (funnel) {
      renderFunnel(funnel);
    } else {
      // –º–∏–Ω–∏–º—É–º: –Ω–∞–π–¥–µ–Ω–æ = total
      renderFunnel({ found: leads_total, hot: hotCount, replied: 0, call: 0 });
    }
    renderTopChats(me.top_chats || []);

    // calibration: –µ—Å–ª–∏ –±—ç–∫ –≥–æ–≤–æ—Ä–∏—Ç –ø–æ–∫–∞–∑–∞—Ç—å
    if (me.show_calibration) {
      document.getElementById('cal-banner').classList.add('show');
    } else {
      document.getElementById('cal-banner').classList.remove('show');
    }

  } catch (e) {
    document.getElementById('leads-list').innerHTML =
      `<div class="empty-state">
        <div class="empty-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
        <div class="empty-sub">${safeText(e.message)}</div>
      </div>`;
    showToast("–û—à–∏–±–∫–∞: " + safeText(e.message));
  }
}

function renderFunnel(f) {
  const found = Number(f.found || f.total || 0);
  const hot = Number(f.hot || 0);
  const replied = Number(f.replied || 0);
  const call = Number(f.call || 0);

  const vals = [found, hot, replied, call];
  const pcts = vals.map(v => found > 0 ? (v / found * 100) : 0);

  setTimeout(() => {
    document.getElementById('f1').style.width = (pcts[0] || 0) + '%';
    document.getElementById('f1').textContent = found;
  }, 200);
  setTimeout(() => {
    document.getElementById('f2').style.width = (pcts[1] || 0) + '%';
    document.getElementById('f2').textContent = hot;
  }, 350);
  setTimeout(() => {
    document.getElementById('f3').style.width = (pcts[2] || 0) + '%';
    document.getElementById('f3').textContent = replied;
  }, 500);
  setTimeout(() => {
    document.getElementById('f4').style.width = (pcts[3] || 0) + '%';
    document.getElementById('f4').textContent = call;
  }, 650);
}

function openLead(userId) {
  userId = Number(userId || 0);
  if (!userId) return;
  tg?.HapticFeedback?.impactOccurred('medium');
  tg?.openTelegramLink(`tg://user?id=${userId}`);
  showToast('–û—Ç–∫—Ä—ã–≤–∞—é —á–∞—Ç‚Ä¶');
}

// --- navigation ---
function switchTab(tab, btn) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  switchSection(tab);
}

function switchSection(sec, btn) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('sec-' + sec).classList.add('active');

  if (btn) {
    document.querySelectorAll('.bnav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  const navBtns = document.querySelectorAll('.nav-btn');
  const tabMap = {leads: 0, profile: 1, analytics: 2};
  if (tabMap[sec] !== undefined) {
    navBtns.forEach(b => b.classList.remove('active'));
    navBtns[tabMap[sec]].classList.add('active');
  }

  tg?.HapticFeedback?.selectionChanged();
}

// --- actions (sendData to bot) ---
function syncPauseButton(paused) {
  const icon = document.getElementById('pause-icon');
  const label = document.getElementById('pause-label');
  const sub = document.getElementById('pause-sub');

  if (paused) {
    icon.textContent = '‚ñ∂Ô∏è';
    label.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å';
    sub.textContent = '–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫';
  } else {
    icon.textContent = '‚è∏';
    label.textContent = '–ü–∞—É–∑–∞';
    sub.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫';
  }
}

function togglePause() {
  const next = !window.__isPaused;
  window.__isPaused = next;
  setStatus(next);
  syncPauseButton(next);

  tg?.HapticFeedback?.impactOccurred('medium');
  tg?.sendData(JSON.stringify({ action: next ? 'pause' : 'resume' }));
  showToast(next ? '‚è∏ –ü–∞—É—á–æ–∫ –Ω–∞ –ø–∞—É–∑–µ' : '‚ñ∂Ô∏è –ü–∞—É—á–æ–∫ —Å–Ω–æ–≤–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç');
}

function renewPlan() {
  tg?.HapticFeedback?.impactOccurred('medium');
  tg?.sendData(JSON.stringify({ action: 'renew' }));
  showToast('–û—Ç–∫—Ä—ã–≤–∞—é –æ–ø–ª–∞—Ç—É‚Ä¶');
}

function upgradeAccount() {
  tg?.HapticFeedback?.impactOccurred('medium');
  tg?.sendData(JSON.stringify({ action: 'upgrade' }));
  showToast('üöÄ –û—Ç–∫—Ä—ã–≤–∞—é –ü—Ä–æ —Ç–∞—Ä–∏—Ñ‚Ä¶');
}

function openSupport() {
  tg?.HapticFeedback?.selectionChanged();
  tg?.sendData(JSON.stringify({ action: 'support' }));
  showToast('üí¨ –û—Ç–∫—Ä—ã–≤–∞—é –ø–æ–¥–¥–µ—Ä–∂–∫—É‚Ä¶');
}

function calibrate(rating) {
  document.getElementById('cal-banner').classList.remove('show');
  tg?.HapticFeedback?.notificationOccurred(rating === 'good' ? 'success' : 'warning');
  tg?.sendData(JSON.stringify({ action: 'calibrate', rating }));
  showToast(rating === 'good' ? 'üëç –ü—Ä–æ–¥–æ–ª–∂–∞—é –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!' : 'üéØ –ü–æ–¥—Å—Ç—Ä–æ—é –ø–æ–∏—Å–∫‚Ä¶');
}

// keep expanded
if (tg) {
  tg.onEvent('viewportChanged', () => {
    if (!tg.isExpanded) tg.expand();
  });
}

// start
loadRealData();
</script>
</body>
</html>
